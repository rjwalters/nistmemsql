name: Label external issues

on:
  issues:
    types: [opened]
  push:
    paths:
      - '.github/workflows/label-external-issues.yml'

permissions:
  issues: write
  contents: read

jobs:
  label_external:
    runs-on: ubuntu-latest
    steps:
      - name: Determine collaborator status
        id: status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" != "issues" ]; then
            echo "status=skipped" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          username="${{ github.event.issue.user.login }}"
          repo="${{ github.repository }}"

          if gh api "repos/${repo}/collaborators/${username}" >/dev/null 2>&1; then
            echo "status=collaborator" >> "$GITHUB_OUTPUT"
            echo "Detected collaborator: ${username}"
          else
            echo "status=external" >> "$GITHUB_OUTPUT"
            echo "Detected external contributor: ${username}"
          fi

      - name: Add 'external' label if needed
        if: steps.status.outputs.status == 'external'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh issue edit ${{ github.event.issue.number }} --add-label external

      - name: Post welcome comment on external issues
        if: steps.status.outputs.status == 'external'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh issue comment ${{ github.event.issue.number }} --body $'Thank you for submitting an issue! üôè\n\nThis issue has been automatically labeled as `external` and will be reviewed by the maintainers.\n\n**Note**: External issues require manual triage before being assigned. We appreciate your patience while we review your submission.\n\nFor questions or discussions, please use [GitHub Discussions](https://github.com/rjwalters/nistmemsql/discussions).'

      - name: Complete without action
        if: steps.status.outputs.status != 'external'
        run: echo "No action needed (status: ${{ steps.status.outputs.status || 'unknown' }})."
