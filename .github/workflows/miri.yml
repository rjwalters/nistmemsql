name: MIRI Undefined Behavior Detection

on:
  push:
    branches: [ main ]
    paths:
      - 'crates/vibesql-storage/src/row.rs'
      - 'crates/vibesql-executor/src/**'
      - '.github/workflows/miri.yml'
  pull_request:
    paths:
      - 'crates/vibesql-storage/src/row.rs'
      - 'crates/vibesql-executor/src/**'
      - '.github/workflows/miri.yml'

jobs:
  miri:
    name: MIRI UB Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust nightly with MIRI
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: miri

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: miri-${{ hashFiles('Cargo.lock') }}

      - name: Setup MIRI
        run: cargo miri setup

      - name: Run MIRI on Row tests
        run: |
          cargo miri test --package vibesql-storage --lib row::tests \
            || (echo "::error::MIRI detected undefined behavior in Row tests" && exit 1)

      - name: Run MIRI on executor tests (sample)
        run: |
          # Run a limited set of executor tests due to MIRI's slowness
          cargo miri test --package vibesql-executor --lib \
            --test-threads=1 \
            -- \
            test_basic \
            || (echo "::warning::Some executor tests failed under MIRI" && true)

      - name: MIRI validation summary
        if: success()
        run: |
          echo "âœ… MIRI validation passed - no undefined behavior detected"
          echo "All unsafe code in Row and executor validated successfully"
