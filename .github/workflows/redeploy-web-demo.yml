name: Redeploy Web Demo

on:
  # Trigger after boost workflow completes on main branch
  workflow_run:
    workflows: ["Boost SQLLogicTest Coverage"]
    types: [completed]
    branches: [main]
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for redeployment'
        required: false
        default: 'Update with latest conformance data'
        type: string

# Sets permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "redeploy-web-demo"
  cancel-in-progress: false

jobs:
  redeploy:
    runs-on: ubuntu-latest
    # Only run if boost workflow succeeded or manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Setup Rust for WASM build
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust-ci-cache"

      # Install wasm-pack for building WASM bindings
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      # Build WASM bindings
      - name: Build WASM bindings
        run: wasm-pack build --target web --out-dir ${{ github.workspace }}/web-demo/public/pkg crates/wasm-bindings --release

      # Setup Node.js for web demo
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web-demo/package-lock.json

      # Install and build web demo
      - name: Install dependencies
        working-directory: web-demo
        run: npm ci

      - name: Build web demo
        working-directory: web-demo
        run: npm run build

      # Download latest conformance data from gh-pages
      - name: Download latest conformance data
        run: |
          echo "Downloading latest conformance data from gh-pages..."

          # Create badges directory
          mkdir -p badges

          # Download cumulative SQLLogicTest results (updated by boost workflow)
          if curl -sL https://rjwalters.github.io/nistmemsql/badges/sqllogictest_cumulative.json \
              -o badges/sqllogictest_cumulative.json; then
            echo "âœ“ Downloaded cumulative SQLLogicTest results"
            jq '.summary' badges/sqllogictest_cumulative.json || echo "Invalid JSON"
          else
            echo "âœ— Failed to download cumulative SQLLogicTest results"
          fi

          # Download sqltest results (from main CI workflow)
          if curl -sL https://rjwalters.github.io/nistmemsql/badges/sqltest_results.json \
              -o badges/sqltest_results.json; then
            echo "âœ“ Downloaded sqltest results"
          else
            echo "âœ— Failed to download sqltest results"
          fi

          # Download benchmark data
          if curl -sL https://rjwalters.github.io/nistmemsql/benchmarks/benchmark_results.json \
              -o badges/benchmark_results.json; then
            echo "âœ“ Downloaded benchmark results"
          else
            echo "âœ— Failed to download benchmark results"
          fi

          if curl -sL https://rjwalters.github.io/nistmemsql/benchmarks/benchmark_history.json \
              -o badges/benchmark_history.json; then
            echo "âœ“ Downloaded benchmark history"
          else
            echo "âœ— Failed to download benchmark history"
          fi

      # Prepare deployment directory
      - name: Prepare deployment
        run: |
          # Create deployment directory
          mkdir -p deploy

          # Copy web demo build output
          cp -r web-demo/dist/* deploy/

          # Create directories for data
          mkdir -p deploy/badges
          mkdir -p deploy/benchmarks

          # Copy all downloaded data
          cp badges/* deploy/badges/ 2>/dev/null || true
          cp badges/benchmark_results.json deploy/benchmarks/ 2>/dev/null || true
          cp badges/benchmark_history.json deploy/benchmarks/ 2>/dev/null || true

          echo "Deployment directory contents:"
          ls -la deploy/
          echo "Badges directory:"
          ls -la deploy/badges/ || echo "No badges"

      # Deploy to GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './deploy'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Post-deployment summary
        run: |
          echo "## ðŸš€ Web Demo Redeployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Boost workflow completion' }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Deployment URL:** https://rjwalters.github.io/nistmemsql/" >> $GITHUB_STEP_SUMMARY
          echo "**Conformance Page:** https://rjwalters.github.io/nistmemsql/conformance.html" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show updated conformance stats if available
          if [ -f badges/sqllogictest_cumulative.json ]; then
            echo "### Latest Conformance Data" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            jq '.summary' badges/sqllogictest_cumulative.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
