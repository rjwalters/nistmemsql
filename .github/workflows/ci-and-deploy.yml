name: CI and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Simpler concurrency: just prevent multiple CI runs on main
concurrency:
  group: ci-main-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # JOB 1: Build and Test
  # ============================================================================
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-suffix: ci

      - name: Run unit tests
        run: cargo test --release -- --skip run_sqllogictest_suite

      - name: Run sqltest conformance suite
        run: cargo test -p vibesql --test sqltest_conformance --release -- --nocapture
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: ci-test-results
          path: |
            target/sqltest_results.json
          retention-days: 90

  # ============================================================================
  # JOB 2: TPC-H Benchmarks
  # ============================================================================
  # NOTE: TPC-H benchmarks are currently too slow for CI (5+ minutes per query)
  # This job is allowed to fail until we implement faster micro-benchmarks
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: test
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-suffix: ci

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run TPC-H benchmarks (quick mode)
        continue-on-error: true
        run: |
          python3 scripts/run_tpch_benchmarks.py --quick --output benchmark_results.json

      - name: Upload benchmark results
        if: always() && hashFiles('benchmark_results.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: ci-benchmark-results
          path: benchmark_results.json
          retention-days: 90

      - name: Display results summary
        if: always() && hashFiles('benchmark_results.json') != ''
        run: |
          echo "## TPC-H Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Real-world decision support queries (TPC-H SF 0.01)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python3 -c "
          import json
          with open('benchmark_results.json') as f:
              data = json.load(f)

          print('| Query | VibeSQL | SQLite | DuckDB |')
          print('|-------|---------|--------|--------|')

          # Group by query
          queries = {}
          for b in data['benchmarks']:
              parts = b['name'].rsplit('_', 1)
              query = parts[0]
              db = parts[1]
              if query not in queries:
                  queries[query] = {}
              queries[query][db] = b['stats']['mean']

          for query in sorted(queries.keys()):
              dbs = queries[query]
              vibesql = f\"{dbs.get('vibesql', 0)*1000:.2f}ms\" if 'vibesql' in dbs else 'N/A'
              sqlite = f\"{dbs.get('sqlite', 0)*1000:.2f}ms\" if 'sqlite' in dbs else 'N/A'
              duckdb = f\"{dbs.get('duckdb', 0)*1000:.2f}ms\" if 'duckdb' in dbs else 'N/A'
              print(f\"| {query.replace('tpch_', '').replace('_', ' ').title()} | {vibesql} | {sqlite} | {duckdb} |\")
          " >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 3: Deploy (calls centralized workflow)
  # NOTE: Only depends on test, not benchmark. Deploy workflow will use:
  #   - New benchmark data if the benchmark job finishes in time
  #   - Historical benchmark data from Pages site otherwise
  # This prevents slow benchmarks from blocking deployment.
  # ============================================================================
  deploy:
    needs: [test]
    uses: ./.github/workflows/deploy-pages.yml
    permissions:
      contents: read
      pages: write
      id-token: write
    with:
      artifact-name: ci-test-results
      benchmark-artifact-name: ci-benchmark-results
      rebuild-web-demo: true
