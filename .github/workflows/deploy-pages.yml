name: Deploy to GitHub Pages

on:
  workflow_call:
    inputs:
      artifact-name:
        description: 'Name of the artifact containing test results/data to deploy (optional)'
        type: string
        required: false
        default: ''
      benchmark-artifact-name:
        description: 'Name of the artifact containing benchmark results (optional)'
        type: string
        required: false
        default: ''
      rebuild-web-demo:
        description: 'Whether to rebuild the web demo from scratch'
        type: boolean
        required: false
        default: true
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        type: string
        required: false
        default: 'Manual deployment'
      rebuild-web-demo:
        description: 'Rebuild web demo'
        type: boolean
        required: false
        default: true

# Sets permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# CRITICAL: Single concurrency group for ALL Pages deployments
# This prevents race conditions from ci-and-deploy, boost, and manual redeploys
concurrency:
  group: pages-deployment
  cancel-in-progress: false  # Queue deployments, don't cancel

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # ============================================================================
      # Build Web Demo (if requested)
      # ============================================================================
      - name: Setup Rust for WASM
        if: inputs.rebuild-web-demo || github.event_name == 'workflow_dispatch'
        uses: ./.github/actions/setup-rust
        with:
          targets: wasm32-unknown-unknown
          cache-key-suffix: wasm

      - name: Install wasm-pack
        if: inputs.rebuild-web-demo || github.event_name == 'workflow_dispatch'
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
        shell: bash

      - name: Clean old WASM files
        if: inputs.rebuild-web-demo || github.event_name == 'workflow_dispatch'
        run: rm -rf web-demo/public/pkg
        shell: bash

      - name: Build WASM bindings
        if: inputs.rebuild-web-demo || github.event_name == 'workflow_dispatch'
        run: wasm-pack build --target web --out-dir ${{ github.workspace }}/web-demo/public/pkg crates/vibesql-wasm-bindings --release
        shell: bash

      - name: Setup pnpm
        if: inputs.rebuild-web-demo || github.event_name == 'workflow_dispatch'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        if: inputs.rebuild-web-demo || github.event_name == 'workflow_dispatch'
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: web-demo/pnpm-lock.yaml

      - name: Build web demo
        if: inputs.rebuild-web-demo || github.event_name == 'workflow_dispatch'
        working-directory: web-demo
        run: |
          pnpm install --frozen-lockfile
          pnpm run build

      # ============================================================================
      # Download Existing Pages Site (to preserve all files)
      # ============================================================================
      - name: Download current Pages site
        if: inputs.rebuild-web-demo == false
        continue-on-error: true
        run: |
          echo "Downloading current Pages site to preserve existing files..."
          mkdir -p pages-temp

          # Download the entire site
          wget -r -np -nH -E -k --cut-dirs=1 \
            -A "*.html,*.js,*.wasm,*.css,*.json,*.svg,*.png,*.jpg,*.jpeg,*.gif,*.woff,*.woff2,*.ttf,*.eot,*.ico,*.md" \
            --reject "*.html.tmp,*.html?*" \
            -P pages-temp \
            https://rjwalters.github.io/vibesql/ || echo "No existing site found"

          # Explicitly download /pkg/ directory
          mkdir -p pages-temp/pkg
          wget -q -P pages-temp/pkg \
            https://rjwalters.github.io/vibesql/pkg/vibesql_wasm_bg.wasm \
            https://rjwalters.github.io/vibesql/pkg/vibesql_wasm.js \
            https://rjwalters.github.io/vibesql/pkg/package.json || echo "No pkg directory found"

      # ============================================================================
      # Download Artifacts from Triggering Workflow
      # ============================================================================
      - name: Download test artifacts
        if: inputs.artifact-name != ''
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: artifacts/

      - name: Download benchmark artifacts
        if: inputs.benchmark-artifact-name != ''
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.benchmark-artifact-name }}
          path: artifacts/

      # ============================================================================
      # Download Historical Data from Pages
      # ============================================================================
      - name: Download historical punchlist results
        continue-on-error: true
        run: |
          echo "Downloading historical SQLLogicTest punchlist results..."
          mkdir -p historical

          if curl -sL https://rjwalters.github.io/vibesql/badges/sqllogictest_punchlist.json \
            -o historical/sqllogictest_punchlist.json 2>/dev/null; then
            if jq empty historical/sqllogictest_punchlist.json 2>/dev/null; then
              echo "âœ“ Downloaded existing punchlist results"
              jq '.summary' historical/sqllogictest_punchlist.json || echo "{}"
            else
              echo "Invalid JSON - will use artifact"
              rm -f historical/sqllogictest_punchlist.json
            fi
          else
            echo "No existing punchlist results - will use artifact"
          fi

      - name: Download historical benchmark data
        continue-on-error: true
        run: |
          echo "Downloading historical benchmark data..."
          mkdir -p historical

          if curl -sL https://rjwalters.github.io/vibesql/benchmarks/benchmark_history.json \
            -o historical/benchmark_history.json; then
            echo "âœ“ Downloaded benchmark history"
          else
            echo "No existing benchmark history found"
          fi

      # ============================================================================
      # Merge Data (if we have new test results)
      # ============================================================================
      - name: Setup Python for punchlist
        if: inputs.artifact-name != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Use punchlist results from artifact
        if: inputs.artifact-name != ''
        continue-on-error: true
        run: |
          # Find punchlist files in artifacts (generated by CI)
          PUNCHLIST_RESULT=$(find artifacts -name "sqllogictest_punchlist.json" | head -1)
          PUNCHLIST_SUMMARY=$(find artifacts -name "sqllogictest_summary.json" | head -1)

          mkdir -p merged
          if [ -n "$PUNCHLIST_RESULT" ] && [ -f "$PUNCHLIST_RESULT" ]; then
            echo "Using punchlist from artifact: $PUNCHLIST_RESULT"
            cp "$PUNCHLIST_RESULT" merged/sqllogictest_punchlist.json
            echo "Punchlist summary:"
            if [ -n "$PUNCHLIST_SUMMARY" ] && [ -f "$PUNCHLIST_SUMMARY" ]; then
              cp "$PUNCHLIST_SUMMARY" merged/sqllogictest_summary.json
              jq '.summary' "$PUNCHLIST_SUMMARY" || echo "{}"
            fi
          elif [ -f historical/sqllogictest_punchlist.json ]; then
            echo "No new punchlist in artifacts - using historical"
            cp historical/sqllogictest_punchlist.json merged/sqllogictest_punchlist.json
          else
            echo "No punchlist available - will generate from scratch"
            # This will be handled by badge generation
          fi

      - name: Update benchmark history
        if: inputs.artifact-name != ''
        continue-on-error: true
        run: |
          # Find benchmark results in artifacts
          BENCHMARK_RESULT=$(find artifacts -name "benchmark_results.json" | head -1)

          if [ -n "$BENCHMARK_RESULT" ] && [ -f "$BENCHMARK_RESULT" ]; then
            echo "Updating benchmark history..."
            python3 benchmarks/update_history.py \
              "$BENCHMARK_RESULT" \
              historical/benchmark_history.json \
              ${{ github.sha }} || echo "Benchmark history update failed"
          else
            echo "No benchmark results in artifacts"
          fi

      # ============================================================================
      # Generate Badges
      # ============================================================================
      - name: Generate badge JSON
        run: |
          mkdir -p badges

          # Find test results (from artifacts or historical)
          SQLTEST_RESULTS=$(find artifacts -name "sqltest_results.json" 2>/dev/null | head -1)
          if [ -z "$SQLTEST_RESULTS" ]; then
            # Try downloading from Pages as fallback
            curl -sL https://rjwalters.github.io/vibesql/badges/sqltest_results.json \
              -o badges/sqltest_results.json 2>/dev/null || echo "{}" > badges/sqltest_results.json
            SQLTEST_RESULTS="badges/sqltest_results.json"
          fi

          # Use merged punchlist results
          SQLLOGICTEST_PUNCHLIST="merged/sqllogictest_punchlist.json"
          if [ ! -f "$SQLLOGICTEST_PUNCHLIST" ]; then
            SQLLOGICTEST_PUNCHLIST="historical/sqllogictest_punchlist.json"
          fi

          # Generate badges using the new script
          ./.github/scripts/generate_badges.sh badges "$SQLTEST_RESULTS" "$SQLLOGICTEST_PUNCHLIST"

      # ============================================================================
      # Prepare Deployment Directory
      # ============================================================================
      - name: Prepare deployment
        run: |
          mkdir -p deploy

          # If we rebuilt web demo, use that
          if [ -d web-demo/dist ]; then
            echo "Using freshly built web demo"
            WEB_DEMO_SOURCE="web-demo/dist"
          # Otherwise use downloaded Pages site
          elif [ -d pages-temp ]; then
            echo "Using existing Pages site"
            WEB_DEMO_SOURCE="pages-temp"
          else
            echo "ERROR: No web demo source found!"
            exit 1
          fi

          # Prepare deployment using the new script
          ./.github/scripts/prepare_deployment.sh \
            deploy \
            "$WEB_DEMO_SOURCE" \
            badges \
            "$(find artifacts historical -name 'benchmark_results.json' 2>/dev/null | head -1)" \
            "historical/benchmark_history.json"

          # Copy merged punchlist results
          if [ -f merged/sqllogictest_punchlist.json ]; then
            cp merged/sqllogictest_punchlist.json deploy/badges/
            echo "âœ“ Copied merged punchlist results"
          fi

          # Copy SQLLogicTest data for web demo
          mkdir -p deploy/data
          if [ -f merged/sqllogictest_punchlist.json ]; then
            cp merged/sqllogictest_punchlist.json deploy/data/
            echo "âœ“ Copied SQLLogicTest punchlist data"
          fi
          if [ -f merged/sqllogictest_summary.json ]; then
            cp merged/sqllogictest_summary.json deploy/data/
            echo "âœ“ Copied SQLLogicTest summary data"
          fi

      # ============================================================================
      # Deploy to GitHub Pages
      # ============================================================================
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './deploy'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://rjwalters.github.io/vibesql/" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Rebuilt web demo:** ${{ inputs.rebuild-web-demo || github.event_name == 'workflow_dispatch' }}" >> $GITHUB_STEP_SUMMARY

          if [ -f deploy/badges/sqllogictest_punchlist.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### SQLLogicTest Punchlist Status" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq '.summary' deploy/badges/sqllogictest_punchlist.json >> $GITHUB_STEP_SUMMARY || echo "{}"
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
