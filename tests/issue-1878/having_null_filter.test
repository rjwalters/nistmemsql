# Test HAVING clause with NULL values and three-valued logic
# Issue: #1878
# Tests that HAVING correctly implements three-valued logic

statement ok
CREATE TABLE sales (region TEXT, amount INTEGER);

statement ok
INSERT INTO sales VALUES ('North', 100);

statement ok
INSERT INTO sales VALUES ('North', 200);

statement ok
INSERT INTO sales VALUES ('South', 150);

statement ok
INSERT INTO sales VALUES (NULL, 50);

statement ok
INSERT INTO sales VALUES (NULL, 75);

# Test 1: HAVING with aggregate comparison
query TI rowsort
SELECT region, SUM(amount) as total
FROM sales
GROUP BY region
HAVING SUM(amount) > 100;
----
NULL	125
North	300
South	150

# Test 2: HAVING with IS NOT NULL - should exclude NULL group
query TI rowsort
SELECT region, COUNT(*) as cnt
FROM sales
GROUP BY region
HAVING region IS NOT NULL;
----
North	2
South	1

# Test 3: HAVING with IS NULL - should only include NULL group
query TI rowsort
SELECT region, COUNT(*) as cnt
FROM sales
GROUP BY region
HAVING region IS NULL;
----
NULL	2

# Test 4: HAVING with three-valued logic - region = 'North' OR SUM(amount) < 100
# - North: region = 'North' is TRUE → include
# - South: region = 'South' is FALSE, SUM(150) < 100 is FALSE → exclude
# - NULL: region = NULL is NULL, SUM(125) < 100 is FALSE → NULL OR FALSE = NULL → exclude
query TI rowsort
SELECT region, SUM(amount) as total
FROM sales
GROUP BY region
HAVING region = 'North' OR SUM(amount) < 100;
----
North	300

# Test 5: HAVING with aggregate only - should work for NULL groups
query TI rowsort
SELECT region, SUM(amount) as total
FROM sales
GROUP BY region
HAVING SUM(amount) < 200;
----
NULL	125
South	150

# Test 6: HAVING that evaluates to NULL should exclude the group
# region = 'East' is FALSE/NULL for all groups, should exclude all
query TI rowsort
SELECT region, COUNT(*) as cnt
FROM sales
GROUP BY region
HAVING region = 'East';
----
